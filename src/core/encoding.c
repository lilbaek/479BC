#include "core/encoding.h"

#include "core/lang.h"
#include "core/string.h"

#include <stdlib.h>

#define HIGH_CHAR_COUNT 128

typedef struct {
    uint8_t internal_value;
    int bytes;
    uint8_t utf8_value[3];
} letter_code;

typedef struct {
    int utf8;
    const letter_code *code;
} from_utf8_lookup;

static const uint8_t NEW_GAME_POLISH[] = { 0x4e, 0x6f, 0x77, 0x61, 0x20, 0x67, 0x72, 0x61, 0 };
static const uint8_t NEW_GAME_RUSSIAN[] = { 0xcd, 0xee, 0xe2, 0xe0, 0xff, 0x20, 0xe8, 0xe3, 0xf0, 0xe0, 0 };

static const letter_code HIGH_TO_UTF8_DEFAULT[HIGH_CHAR_COUNT] = {
    {0x80, 3, {0xe2, 0x82, 0xac}},
    {0x81, 1, {0x3f}},
    {0x82, 3, {0xe2, 0x80, 0x9a}},
    {0x83, 2, {0xc6, 0x92}},
    {0x84, 3, {0xe2, 0x80, 0x9e}},
    {0x85, 3, {0xe2, 0x80, 0xa6}},
    {0x86, 3, {0xe2, 0x80, 0xa0}},
    {0x87, 3, {0xe2, 0x80, 0xa1}},
    {0x88, 2, {0xcb, 0x86}},
    {0x89, 3, {0xe2, 0x80, 0xb0}},
    {0x8a, 2, {0xc5, 0xa0}},
    {0x8b, 3, {0xe2, 0x80, 0xb9}},
    {0x8c, 2, {0xc5, 0x92}},
    {0x8d, 1, {0x3f}},
    {0x8e, 2, {0xc5, 0xbd}},
    {0x8f, 1, {0x3f}},
    {0x90, 1, {0x3f}},
    {0x91, 3, {0xe2, 0x80, 0x98}},
    {0x92, 3, {0xe2, 0x80, 0x99}},
    {0x93, 3, {0xe2, 0x80, 0x9c}},
    {0x94, 3, {0xe2, 0x80, 0x9d}},
    {0x95, 3, {0xe2, 0x80, 0xa2}},
    {0x96, 3, {0xe2, 0x80, 0x93}},
    {0x97, 3, {0xe2, 0x80, 0x94}},
    {0x98, 2, {0xcb, 0x9c}},
    {0x99, 3, {0xe2, 0x84, 0xa2}},
    {0x9a, 2, {0xc5, 0xa1}},
    {0x9b, 3, {0xe2, 0x80, 0xba}},
    {0x9c, 2, {0xc5, 0x93}},
    {0x9d, 1, {0x3f}},
    {0x9e, 2, {0xc5, 0xbe}},
    {0x9f, 2, {0xc5, 0xb8}},
    {0xa0, 2, {0xc2, 0xa0}},
    {0xa1, 2, {0xc2, 0xa1}},
    {0xa2, 2, {0xc2, 0xa2}},
    {0xa3, 2, {0xc2, 0xa3}},
    {0xa4, 2, {0xc2, 0xa4}},
    {0xa5, 2, {0xc2, 0xa5}},
    {0xa6, 2, {0xc2, 0xa6}},
    {0xa7, 2, {0xc2, 0xa7}},
    {0xa8, 2, {0xc2, 0xa8}},
    {0xa9, 2, {0xc2, 0xa9}},
    {0xaa, 2, {0xc2, 0xaa}},
    {0xab, 2, {0xc2, 0xab}},
    {0xac, 2, {0xc2, 0xac}},
    {0xad, 2, {0xc2, 0xad}},
    {0xae, 2, {0xc2, 0xae}},
    {0xaf, 2, {0xc2, 0xaf}},
    {0xb0, 2, {0xc2, 0xb0}},
    {0xb1, 2, {0xc2, 0xb1}},
    {0xb2, 2, {0xc2, 0xb2}},
    {0xb3, 2, {0xc2, 0xb3}},
    {0xb4, 2, {0xc2, 0xb4}},
    {0xb5, 2, {0xc2, 0xb5}},
    {0xb6, 2, {0xc2, 0xb6}},
    {0xb7, 2, {0xc2, 0xb7}},
    {0xb8, 2, {0xc2, 0xb8}},
    {0xb9, 2, {0xc2, 0xb9}},
    {0xba, 2, {0xc2, 0xba}},
    {0xbb, 2, {0xc2, 0xbb}},
    {0xbc, 2, {0xc2, 0xbc}},
    {0xbd, 2, {0xc2, 0xbd}},
    {0xbe, 2, {0xc2, 0xbe}},
    {0xbf, 2, {0xc2, 0xbf}},
    {0xc0, 2, {0xc3, 0x80}},
    {0xc1, 2, {0xc3, 0x81}},
    {0xc2, 2, {0xc3, 0x82}},
    {0xc3, 2, {0xc3, 0x83}},
    {0xc4, 2, {0xc3, 0x84}},
    {0xc5, 2, {0xc3, 0x85}},
    {0xc6, 2, {0xc3, 0x86}},
    {0xc7, 2, {0xc3, 0x87}},
    {0xc8, 2, {0xc3, 0x88}},
    {0xc9, 2, {0xc3, 0x89}},
    {0xca, 2, {0xc3, 0x8a}},
    {0xcb, 2, {0xc3, 0x8b}},
    {0xcc, 2, {0xc3, 0x8c}},
    {0xcd, 2, {0xc3, 0x8d}},
    {0xce, 2, {0xc3, 0x8e}},
    {0xcf, 2, {0xc3, 0x8f}},
    {0xd0, 2, {0xc3, 0x90}},
    {0xd1, 2, {0xc3, 0x91}},
    {0xd2, 2, {0xc3, 0x92}},
    {0xd3, 2, {0xc3, 0x93}},
    {0xd4, 2, {0xc3, 0x94}},
    {0xd5, 2, {0xc3, 0x95}},
    {0xd6, 2, {0xc3, 0x96}},
    {0xd7, 2, {0xc3, 0x97}},
    {0xd8, 2, {0xc3, 0x98}},
    {0xd9, 2, {0xc3, 0x99}},
    {0xda, 2, {0xc3, 0x9a}},
    {0xdb, 2, {0xc3, 0x9b}},
    {0xdc, 2, {0xc3, 0x9c}},
    {0xdd, 2, {0xc3, 0x9d}},
    {0xde, 2, {0xc3, 0x9e}},
    {0xdf, 2, {0xc3, 0x9f}},
    {0xe0, 2, {0xc3, 0xa0}},
    {0xe1, 2, {0xc3, 0xa1}},
    {0xe2, 2, {0xc3, 0xa2}},
    {0xe3, 2, {0xc3, 0xa3}},
    {0xe4, 2, {0xc3, 0xa4}},
    {0xe5, 2, {0xc3, 0xa5}},
    {0xe6, 2, {0xc3, 0xa6}},
    {0xe7, 2, {0xc3, 0xa7}},
    {0xe8, 2, {0xc3, 0xa8}},
    {0xe9, 2, {0xc3, 0xa9}},
    {0xea, 2, {0xc3, 0xaa}},
    {0xeb, 2, {0xc3, 0xab}},
    {0xec, 2, {0xc3, 0xac}},
    {0xed, 2, {0xc3, 0xad}},
    {0xee, 2, {0xc3, 0xae}},
    {0xef, 2, {0xc3, 0xaf}},
    {0xf0, 2, {0xc3, 0xb0}},
    {0xf1, 2, {0xc3, 0xb1}},
    {0xf2, 2, {0xc3, 0xb2}},
    {0xf3, 2, {0xc3, 0xb3}},
    {0xf4, 2, {0xc3, 0xb4}},
    {0xf5, 2, {0xc3, 0xb5}},
    {0xf6, 2, {0xc3, 0xb6}},
    {0xf7, 2, {0xc3, 0xb7}},
    {0xf8, 2, {0xc3, 0xb8}},
    {0xf9, 2, {0xc3, 0xb9}},
    {0xfa, 2, {0xc3, 0xba}},
    {0xfb, 2, {0xc3, 0xbb}},
    {0xfc, 2, {0xc3, 0xbc}},
    {0xfd, 2, {0xc3, 0xbd}},
    {0xfe, 2, {0xc3, 0xbe}},
    {0xff, 2, {0xc3, 0xbf}},
};

static const letter_code HIGH_TO_UTF8_EASTERN[HIGH_CHAR_COUNT] = {
    {0x80, 3, {0xe2, 0x82, 0xac}},
    {0x81, 1, {0x3f}},
    {0x82, 3, {0xe2, 0x80, 0x9a}},
    {0x83, 1, {0x3f}},
    {0x84, 3, {0xe2, 0x80, 0x9e}},
    {0x85, 3, {0xe2, 0x80, 0xa6}},
    {0x86, 3, {0xe2, 0x80, 0xa0}},
    {0x87, 3, {0xe2, 0x80, 0xa1}},
    {0x88, 1, {0x3f}},
    {0x89, 3, {0xe2, 0x80, 0xb0}},
    {0x8a, 2, {0xc5, 0xa0}},
    {0x8b, 3, {0xe2, 0x80, 0xb9}},
    {0x8c, 2, {0xc5, 0x9a}},
    {0x8d, 2, {0xc5, 0xa4}},
    {0x8e, 2, {0xc5, 0xbd}},
    {0x8f, 2, {0xc5, 0xb9}},
    {0x90, 1, {0x3f}},
    {0x91, 3, {0xe2, 0x80, 0x98}},
    {0x92, 3, {0xe2, 0x80, 0x99}},
    {0x93, 3, {0xe2, 0x80, 0x9c}},
    {0x94, 3, {0xe2, 0x80, 0x9d}},
    {0x95, 3, {0xe2, 0x80, 0xa2}},
    {0x96, 3, {0xe2, 0x80, 0x93}},
    {0x97, 3, {0xe2, 0x80, 0x94}},
    {0x98, 1, {0x3f}},
    {0x99, 3, {0xe2, 0x84, 0xa2}},
    {0x9a, 2, {0xc5, 0xa1}},
    {0x9b, 3, {0xe2, 0x80, 0xba}},
    {0x9c, 2, {0xc5, 0x9b}},
    {0x9d, 2, {0xc5, 0xa5}},
    {0x9e, 2, {0xc5, 0xbe}},
    {0x9f, 2, {0xc5, 0xba}},
    {0xa0, 2, {0xc2, 0xa0}},
    {0xa1, 2, {0xcb, 0x87}},
    {0xa2, 2, {0xcb, 0x98}},
    {0xa3, 2, {0xc5, 0x81}},
    {0xa4, 2, {0xc2, 0xa4}},
    {0xa5, 2, {0xc4, 0x84}},
    {0xa6, 2, {0xc2, 0xa6}},
    {0xa7, 2, {0xc2, 0xa7}},
    {0xa8, 2, {0xc2, 0xa8}},
    {0xa9, 2, {0xc2, 0xa9}},
    {0xaa, 2, {0xc5, 0x9e}},
    {0xab, 2, {0xc2, 0xab}},
    {0xac, 2, {0xc2, 0xac}},
    {0xad, 2, {0xc2, 0xad}},
    {0xae, 2, {0xc2, 0xae}},
    {0xaf, 2, {0xc5, 0xbb}},
    {0xb0, 2, {0xc2, 0xb0}},
    {0xb1, 2, {0xc2, 0xb1}},
    {0xb2, 2, {0xcb, 0x9b}},
    {0xb3, 2, {0xc5, 0x82}},
    {0xb4, 2, {0xc2, 0xb4}},
    {0xb5, 2, {0xc2, 0xb5}},
    {0xb6, 2, {0xc2, 0xb6}},
    {0xb7, 2, {0xc2, 0xb7}},
    {0xb8, 2, {0xc2, 0xb8}},
    {0xb9, 2, {0xc4, 0x85}},
    {0xba, 2, {0xc5, 0x9f}},
    {0xbb, 2, {0xc2, 0xbb}},
    {0xbc, 2, {0xc4, 0xbd}},
    {0xbd, 2, {0xcb, 0x9d}},
    {0xbe, 2, {0xc4, 0xbe}},
    {0xbf, 2, {0xc5, 0xbc}},
    {0xc0, 2, {0xc5, 0x94}},
    {0xc1, 2, {0xc3, 0x81}},
    {0xc2, 2, {0xc3, 0x82}},
    {0xc3, 2, {0xc4, 0x82}},
    {0xc4, 2, {0xc3, 0x84}},
    {0xc5, 2, {0xc4, 0xb9}},
    {0xc6, 2, {0xc4, 0x86}},
    {0xc7, 2, {0xc3, 0x87}},
    {0xc8, 2, {0xc4, 0x8c}},
    {0xc9, 2, {0xc3, 0x89}},
    {0xca, 2, {0xc4, 0x98}},
    {0xcb, 2, {0xc3, 0x8b}},
    {0xcc, 2, {0xc4, 0x9a}},
    {0xcd, 2, {0xc3, 0x8d}},
    {0xce, 2, {0xc3, 0x8e}},
    {0xcf, 2, {0xc4, 0x8e}},
    {0xd0, 2, {0xc4, 0x90}},
    {0xd1, 2, {0xc5, 0x83}},
    {0xd2, 2, {0xc5, 0x87}},
    {0xd3, 2, {0xc3, 0x93}},
    {0xd4, 2, {0xc3, 0x94}},
    {0xd5, 2, {0xc5, 0x90}},
    {0xd6, 2, {0xc3, 0x96}},
    {0xd7, 2, {0xc3, 0x97}},
    {0xd8, 2, {0xc5, 0x98}},
    {0xd9, 2, {0xc5, 0xae}},
    {0xda, 2, {0xc3, 0x9a}},
    {0xdb, 2, {0xc5, 0xb0}},
    {0xdc, 2, {0xc3, 0x9c}},
    {0xdd, 2, {0xc3, 0x9d}},
    {0xde, 2, {0xc5, 0xa2}},
    {0xdf, 2, {0xc3, 0x9f}},
    {0xe0, 2, {0xc5, 0x95}},
    {0xe1, 2, {0xc3, 0xa1}},
    {0xe2, 2, {0xc3, 0xa2}},
    {0xe3, 2, {0xc4, 0x83}},
    {0xe4, 2, {0xc3, 0xa4}},
    {0xe5, 2, {0xc4, 0xba}},
    {0xe6, 2, {0xc4, 0x87}},
    {0xe7, 2, {0xc3, 0xa7}},
    {0xe8, 2, {0xc4, 0x8d}},
    {0xe9, 2, {0xc3, 0xa9}},
    {0xea, 2, {0xc4, 0x99}},
    {0xeb, 2, {0xc3, 0xab}},
    {0xec, 2, {0xc4, 0x9b}},
    {0xed, 2, {0xc3, 0xad}},
    {0xee, 2, {0xc3, 0xae}},
    {0xef, 2, {0xc4, 0x8f}},
    {0xf0, 2, {0xc4, 0x91}},
    {0xf1, 2, {0xc5, 0x84}},
    {0xf2, 2, {0xc5, 0x88}},
    {0xf3, 2, {0xc3, 0xb3}},
    {0xf4, 2, {0xc3, 0xb4}},
    {0xf5, 2, {0xc5, 0x91}},
    {0xf6, 2, {0xc3, 0xb6}},
    {0xf7, 2, {0xc3, 0xb7}},
    {0xf8, 2, {0xc5, 0x99}},
    {0xf9, 2, {0xc5, 0xaf}},
    {0xfa, 2, {0xc3, 0xba}},
    {0xfb, 2, {0xc5, 0xb1}},
    {0xfc, 2, {0xc3, 0xbc}},
    {0xfd, 2, {0xc3, 0xbd}},
    {0xfe, 2, {0xc5, 0xa3}},
    {0xff, 2, {0xcb, 0x99}},
};

static const letter_code HIGH_TO_UTF8_CYRILLIC[HIGH_CHAR_COUNT] = {
    {0x80, 2, {0xd0, 0x82}},
    {0x81, 2, {0xd0, 0x83}},
    {0x82, 3, {0xe2, 0x80, 0x9a}},
    {0x83, 2, {0xd1, 0x93}},
    {0x84, 3, {0xe2, 0x80, 0x9e}},
    {0x85, 3, {0xe2, 0x80, 0xa6}},
    {0x86, 3, {0xe2, 0x80, 0xa0}},
    {0x87, 3, {0xe2, 0x80, 0xa1}},
    {0x88, 3, {0xe2, 0x82, 0xac}},
    {0x89, 3, {0xe2, 0x80, 0xb0}},
    {0x8a, 2, {0xd0, 0x89}},
    {0x8b, 3, {0xe2, 0x80, 0xb9}},
    {0x8c, 2, {0xd0, 0x8a}},
    {0x8d, 2, {0xd0, 0x8c}},
    {0x8e, 2, {0xd0, 0x8b}},
    {0x8f, 2, {0xd0, 0x8f}},
    {0x90, 2, {0xd1, 0x92}},
    {0x91, 3, {0xe2, 0x80, 0x98}},
    {0x92, 3, {0xe2, 0x80, 0x99}},
    {0x93, 3, {0xe2, 0x80, 0x9c}},
    {0x94, 3, {0xe2, 0x80, 0x9d}},
    {0x95, 3, {0xe2, 0x80, 0xa2}},
    {0x96, 3, {0xe2, 0x80, 0x93}},
    {0x97, 3, {0xe2, 0x80, 0x94}},
    {0x98, 1, {0x3f}},
    {0x99, 3, {0xe2, 0x84, 0xa2}},
    {0x9a, 2, {0xd1, 0x99}},
    {0x9b, 3, {0xe2, 0x80, 0xba}},
    {0x9c, 2, {0xd1, 0x9a}},
    {0x9d, 2, {0xd1, 0x9c}},
    {0x9e, 2, {0xd1, 0x9b}},
    {0x9f, 2, {0xd1, 0x9f}},
    {0xa0, 2, {0xc2, 0xa0}},
    {0xa1, 2, {0xd0, 0x8e}},
    {0xa2, 2, {0xd1, 0x9e}},
    {0xa3, 2, {0xd0, 0x88}},
    {0xa4, 2, {0xc2, 0xa4}},
    {0xa5, 2, {0xd2, 0x90}},
    {0xa6, 2, {0xc2, 0xa6}},
    {0xa7, 2, {0xc2, 0xa7}},
    {0xa8, 2, {0xd0, 0x81}},
    {0xa9, 2, {0xc2, 0xa9}},
    {0xaa, 2, {0xd0, 0x84}},
    {0xab, 2, {0xc2, 0xab}},
    {0xac, 2, {0xc2, 0xac}},
    {0xad, 2, {0xc2, 0xad}},
    {0xae, 2, {0xc2, 0xae}},
    {0xaf, 2, {0xd0, 0x87}},
    {0xb0, 2, {0xc2, 0xb0}},
    {0xb1, 2, {0xc2, 0xb1}},
    {0xb2, 2, {0xd0, 0x86}},
    {0xb3, 2, {0xd1, 0x96}},
    {0xb4, 2, {0xd2, 0x91}},
    {0xb5, 2, {0xc2, 0xb5}},
    {0xb6, 2, {0xc2, 0xb6}},
    {0xb7, 2, {0xc2, 0xb7}},
    {0xb8, 2, {0xd1, 0x91}},
    {0xb9, 3, {0xe2, 0x84, 0x96}},
    {0xba, 2, {0xd1, 0x94}},
    {0xbb, 2, {0xc2, 0xbb}},
    {0xbc, 2, {0xd1, 0x98}},
    {0xbd, 2, {0xd0, 0x85}},
    {0xbe, 2, {0xd1, 0x95}},
    {0xbf, 2, {0xd1, 0x97}},
    {0xc0, 2, {0xd0, 0x90}},
    {0xc1, 2, {0xd0, 0x91}},
    {0xc2, 2, {0xd0, 0x92}},
    {0xc3, 2, {0xd0, 0x93}},
    {0xc4, 2, {0xd0, 0x94}},
    {0xc5, 2, {0xd0, 0x95}},
    {0xc6, 2, {0xd0, 0x96}},
    {0xc7, 2, {0xd0, 0x97}},
    {0xc8, 2, {0xd0, 0x98}},
    {0xc9, 2, {0xd0, 0x99}},
    {0xca, 2, {0xd0, 0x9a}},
    {0xcb, 2, {0xd0, 0x9b}},
    {0xcc, 2, {0xd0, 0x9c}},
    {0xcd, 2, {0xd0, 0x9d}},
    {0xce, 2, {0xd0, 0x9e}},
    {0xcf, 2, {0xd0, 0x9f}},
    {0xd0, 2, {0xd0, 0xa0}},
    {0xd1, 2, {0xd0, 0xa1}},
    {0xd2, 2, {0xd0, 0xa2}},
    {0xd3, 2, {0xd0, 0xa3}},
    {0xd4, 2, {0xd0, 0xa4}},
    {0xd5, 2, {0xd0, 0xa5}},
    {0xd6, 2, {0xd0, 0xa6}},
    {0xd7, 2, {0xd0, 0xa7}},
    {0xd8, 2, {0xd0, 0xa8}},
    {0xd9, 2, {0xd0, 0xa9}},
    {0xda, 2, {0xd0, 0xaa}},
    {0xdb, 2, {0xd0, 0xab}},
    {0xdc, 2, {0xd0, 0xac}},
    {0xdd, 2, {0xd0, 0xad}},
    {0xde, 2, {0xd0, 0xae}},
    {0xdf, 2, {0xd0, 0xaf}},
    {0xe0, 2, {0xd0, 0xb0}},
    {0xe1, 2, {0xd0, 0xb1}},
    {0xe2, 2, {0xd0, 0xb2}},
    {0xe3, 2, {0xd0, 0xb3}},
    {0xe4, 2, {0xd0, 0xb4}},
    {0xe5, 2, {0xd0, 0xb5}},
    {0xe6, 2, {0xd0, 0xb6}},
    {0xe7, 2, {0xd0, 0xb7}},
    {0xe8, 2, {0xd0, 0xb8}},
    {0xe9, 2, {0xd0, 0xb9}},
    {0xea, 2, {0xd0, 0xba}},
    {0xeb, 2, {0xd0, 0xbb}},
    {0xec, 2, {0xd0, 0xbc}},
    {0xed, 2, {0xd0, 0xbd}},
    {0xee, 2, {0xd0, 0xbe}},
    {0xef, 2, {0xd0, 0xbf}},
    {0xf0, 2, {0xd1, 0x80}},
    {0xf1, 2, {0xd1, 0x81}},
    {0xf2, 2, {0xd1, 0x82}},
    {0xf3, 2, {0xd1, 0x83}},
    {0xf4, 2, {0xd1, 0x84}},
    {0xf5, 2, {0xd1, 0x85}},
    {0xf6, 2, {0xd1, 0x86}},
    {0xf7, 2, {0xd1, 0x87}},
    {0xf8, 2, {0xd1, 0x88}},
    {0xf9, 2, {0xd1, 0x89}},
    {0xfa, 2, {0xd1, 0x8a}},
    {0xfb, 2, {0xd1, 0x8b}},
    {0xfc, 2, {0xd1, 0x8c}},
    {0xfd, 2, {0xd1, 0x8d}},
    {0xfe, 2, {0xd1, 0x8e}},
    {0xff, 2, {0xd1, 0x8f}},
};

static encoding_type encoding;
static from_utf8_lookup from_utf8_table[HIGH_CHAR_COUNT];
static const letter_code *to_utf8_table;

static int calculate_utf8_value(const letter_code *code)
{
    int value = 0;
    if (code->bytes >= 1) {
        value |= code->utf8_value[0];
    }
    if (code->bytes >= 2) {
        value |= code->utf8_value[1] << 8;
    }
    if (code->bytes >= 3) {
        value |= code->utf8_value[2] << 16;
    }
    return value;
}

static int compare_utf8_lookup(const void *a, const void *b)
{
    return ((const from_utf8_lookup*) a)->utf8 - ((const from_utf8_lookup*) b)->utf8;
}

static void build_reverse_lookup_table(void)
{
    for (int i = 0; i < HIGH_CHAR_COUNT; i++) {
        const letter_code *code = &to_utf8_table[i];
        from_utf8_table[i].code = code;
        from_utf8_table[i].utf8 = calculate_utf8_value(code);
    }
    qsort(from_utf8_table, HIGH_CHAR_COUNT, sizeof(from_utf8_lookup), compare_utf8_lookup);
}

static const letter_code* get_letter_code_for_internal(uint8_t c)
{
    if (c < 0x80) {
        return NULL;
    }
    return &to_utf8_table[c - 0x80];
}

static const letter_code* get_letter_code_for_utf8(const char *c, int *num_bytes)
{
    from_utf8_lookup key;
    const uint8_t *uc = (const uint8_t *) c;
    if ((uc[0] & 0xe0) == 0xc0 && (uc[1] & 0xc0) == 0x80) {
        // 2-byte character
        if (num_bytes) *num_bytes = 2;
        key.utf8 = uc[0] | uc[1] << 8;
    } else if ((uc[0] & 0xf0) == 0xe0 && (uc[1] & 0xc0) == 0x80 && (uc[2] & 0xc0) == 0x80) {
        // 3-byte character
        if (num_bytes) *num_bytes = 3;
        key.utf8 = uc[0] | uc[1] << 8 | uc[2] << 16;
    } else {
        if (num_bytes) *num_bytes = 1;
    }
    if (key.utf8 == 0) {
        return NULL;
    }
    return bsearch(&key, from_utf8_table, HIGH_CHAR_COUNT, sizeof(from_utf8_lookup), compare_utf8_lookup);
}

encoding_type encoding_determine(void)
{
    // A really dirty way to 'detect' encoding:
    // - Windows-1250 (Central/Eastern Europe) is used in Polish only
    // - Windows-1251 (Cyrillic) is used in Russian only
    // - Windows-1252 (Western Europe) is used in all other languages
    // Check if the string for "New game" is Polish or Russian
    const uint8_t *new_game_string = lang_get_string(1, 1);
    if (string_equals(NEW_GAME_POLISH, new_game_string)) {
        to_utf8_table = HIGH_TO_UTF8_EASTERN;
        encoding = ENCODING_EASTERN_EUROPE;
    } else if (string_equals(NEW_GAME_RUSSIAN, new_game_string)) {
        to_utf8_table = HIGH_TO_UTF8_CYRILLIC;
        encoding = ENCODING_CYRILLIC;
    } else {
        to_utf8_table = HIGH_TO_UTF8_DEFAULT;
        encoding = ENCODING_WESTERN_EUROPE;
    }
    build_reverse_lookup_table();
    return encoding;
}

encoding_type encoding_get(void)
{
    return encoding;
}

static int is_ascii(const char *utf8_char)
{
    return ((uint8_t) *utf8_char & 0x80) == 0;
}

int encoding_can_display(const char *utf8_char)
{
    return is_ascii(utf8_char) || get_letter_code_for_utf8(utf8_char, NULL) != NULL;
}

void encoding_to_utf8(const uint8_t *input, char *output, int output_length)
{
    const char *max_output = &output[output_length - 1];
    
    while (*input && output < max_output) {
        uint8_t c = *input;
        if (c < 0x80) {
            *output = c;
            ++output;
        } else {
            // multi-byte char
            const letter_code *code = get_letter_code_for_internal(c);
            if (code->bytes) {
                if (output + code->bytes >= max_output) {
                    break;
                }
                for (int i = 0; i < code->bytes; i++) {
                    *output = code->utf8_value[i];
                    ++output;
                }
            }
        }
        ++input;
    }
    *output = 0;
}

void encoding_from_utf8(const char *input, uint8_t *output, int output_length)
{
    const uint8_t *max_output = &output[output_length - 1];
    
    while (*input && output < max_output) {
        if (is_ascii(input)) {
            *output = *input;
            ++output;
            ++input;
        } else {
            // multi-byte char
            int bytes;
            const letter_code *code = get_letter_code_for_utf8(input, &bytes);
            if (code) {
                *output = code->internal_value;
                input += bytes;
            } else {
                *output = '?';
                input += bytes;
            }
            ++output;
        }
    }
    *output = 0;
}
